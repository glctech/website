<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Proposta Comercial - GLCTech</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; }
    h1 { color: #c00; margin-bottom: 30px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    th { background: #eee; }
    tr.group-header th {
      background: #c00; color:#fff; text-align:left;
      font-size:1.1em; padding-left:15px;
      border-top:3px solid #900; border-bottom:3px solid #900;
    }
    input[type="number"], input[type="text"] {
      width:90px; padding:4px; border:1px solid #ccc;
      border-radius:4px; text-align:center;
    }
    input[type="text"] {
      width: 100%; text-align: left;
    }
    .totals { font-size:1.2em; margin-bottom:40px; font-weight: bold; text-align: right; }
    .highlight { font-weight:bold; color:#007b00; }
    button {
      display:block; margin:0 auto 20px auto;
      padding:12px 30px; font-size:1.1em;
      color:#fff; background:#c00;
      border:none; border-radius:5px;
      cursor:pointer; transition: background .3s;
    }
    button:hover { background:#900; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <h1>Proposta Comercial - GLCTech</h1>
  <table id="faturamento">
    <thead>
      <tr>
        <th>Serviço</th>
        <th>Descrição</th>
        <th>Preço Unitário (R$)</th>
        <th>Quantidade/Mês</th>
        <th>Total (R$)</th>
      </tr>
    </thead>
    <tbody>
      <tr class="group-header"><th colspan="5">Licenças</th></tr>
      <tr>
        <td>Licença Kaspersky (anual ÷12)</td>
        <td><input type="text" placeholder="Ex: Proteção antivírus para estações" class="input-descricao"/></td>
        <td><input type="number" step="0.01" value="800" class="input-preco"/></td>
        <td><input type="number" step="1" value="3" class="input-quantidade"/></td>
        <td class="total dividido"></td>
      </tr>
      <tr class="group-header"><th colspan="5">Softwares</th></tr>
      <tr>
        <td>Setup Grafana</td>
        <td><input type="text" placeholder="Ex: Implantar dashboards personalizados" class="input-descricao"/></td>
        <td><input type="number" step="0.01" value="2000" class="input-preco"/></td>
        <td><input type="number" step="1" value="2" class="input-quantidade"/></td>
        <td class="total"></td>
      </tr>
      <tr class="group-header"><th colspan="5">Serviços</th></tr>
      <tr>
        <td>Monitoramento Zabbix</td>
        <td><input type="text" placeholder="Ex: Monitoramento de servidores e aplicações" class="input-descricao"/></td>
        <td><input type="number" step="0.01" value="500" class="input-preco"/></td>
        <td><input type="number" step="1" value="4" class="input-quantidade"/></td>
        <td class="total"></td>
      </tr>
      <tr>
        <td>Serviços AWS</td>
        <td><input type="text" placeholder="Ex: Serviços de cloud sob demanda" class="input-descricao"/></td>
        <td><input type="number" step="0.01" value="1000" class="input-preco"/></td>
        <td><input type="number" step="1" value="2" class="input-quantidade"/></td>
        <td class="total"></td>
      </tr>
      <tr>
        <td>Veeam Backup</td>
        <td><input type="text" placeholder="Ex: Backup automatizado de ambientes" class="input-descricao"/></td>
        <td><input type="number" step="0.01" value="1500" class="input-preco"/></td>
        <td><input type="number" step="1" value="2" class="input-quantidade"/></td>
        <td class="total"></td>
      </tr>
      <tr class="group-header"><th colspan="5">Consultoria</th></tr>
      <tr>
        <td>Consultoria Técnica (horas)</td>
        <td><input type="text" placeholder="Ex: Apoio técnico especializado" class="input-descricao"/></td>
        <td><input type="number" step="0.01" value="150" class="input-preco"/></td>
        <td><input type="number" step="1" value="40" class="input-quantidade"/></td>
        <td class="total"></td>
      </tr>
    </tbody>
  </table>
  <div class="totals">
    Total Geral: <span id="totalGeral" class="highlight">R$ 0,00</span>
  </div>
  <button id="btn-gerar-proposta">Gerar Proposta Comercial</button>

  <script>
    function formatBRL(value) {
      return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function recalcularTotais() {
      const rows = document.querySelectorAll('#faturamento tbody tr');
      let totalGeral = 0;

      rows.forEach(row => {
        if (row.classList.contains('group-header')) return;

        const preco = parseFloat(row.querySelector('.input-preco').value) || 0;
        const quantidade = parseInt(row.querySelector('.input-quantidade').value) || 0;

        let totalLinha = row.querySelector('.dividido') ? (preco * quantidade) / 12 : preco * quantidade;

        row.querySelector('.total').innerText = formatBRL(totalLinha);

        totalGeral += totalLinha;
      });

      document.getElementById('totalGeral').innerText = formatBRL(totalGeral);

      return totalGeral;
    }

    document.querySelectorAll('.input-preco, .input-quantidade').forEach(input => {
      input.addEventListener('input', recalcularTotais);
    });

    window.onload = () => {
      document.querySelectorAll('#faturamento tbody tr').forEach(row => {
        if (row.querySelector('.dividido')) {
          row.querySelector('.total').classList.add('dividido');
        }
      });
      recalcularTotais();
    };

    async function getBase64ImageFromURL(url) {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      return new Promise((resolve, reject) => {
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          canvas.getContext('2d').drawImage(img, 0, 0);
          resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = err => reject(err);
        img.src = url;
      });
    }

    document.getElementById('btn-gerar-proposta').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      try {
        const logo = await getBase64ImageFromURL('https://glctech.com.br/img/logo7.png');

        // Cabeçalho
        doc.addImage(logo, 'PNG', 14, 10, 40, 0);
        doc.setFontSize(16);
        doc.setTextColor('#c00');
        doc.text('Proposta Comercial', 70, 20);
        doc.setTextColor(0);
        doc.setFontSize(11);
        doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 70, 28);

        let y = 40;

        // Texto introdutório
        doc.setFontSize(11);
        doc.text('Prezados,', 14, y);
        doc.text('Agradecemos pela oportunidade de apresentar nossa proposta de soluções tecnológicas personalizadas.', 14, y + 6);
        doc.text('A GLCTech atua com foco em qualidade, segurança e inovação, oferecendo serviços robustos que', 14, y + 12);
        doc.text('atendem empresas de todos os portes.', 14, y + 18);
        doc.text('Abaixo estão listadas as soluções recomendadas, com base nas necessidades identificadas.', 14, y + 26);
        doc.text('Esta proposta contempla licenças, infraestrutura, monitoramento, consultorias e serviços', 14, y + 32);
        doc.text('estratégicos que otimizam a performance e garantem a continuidade dos seus negócios.', 14, y + 38);
        doc.text('Estamos à disposição para esclarecer dúvidas e ajustar a proposta conforme suas expectativas.', 14, y + 44);
        y += 60;

        // Montar tabela
        const rows = [];
        document.querySelectorAll('#faturamento tbody tr').forEach(row => {
          if (row.classList.contains('group-header')) {
            rows.push([{
              content: row.children[0].innerText,
              colSpan: 5,
              styles: { fillColor: [200, 0, 0], textColor: 255, halign: 'left', fontStyle: 'bold' }
            }]);
          } else {
            const servico = row.children[0].innerText;
            const descricao = row.querySelector('.input-descricao').value || '-';
            const preco = row.querySelector('.input-preco').value;
            const quantidade = row.querySelector('.input-quantidade').value;
            const total = row.querySelector('.total').innerText;

            rows.push([servico, descricao, `R$ ${preco}`, quantidade, total]);
          }
        });

        doc.autoTable({
          startY: y,
          head: [['Serviço', 'Descrição', 'Preço Unitário', 'Qtd/Mês', 'Total']],
          body: rows,
          theme: 'grid',
          styles: { fontSize: 9, cellPadding: 3 },
          headStyles: { fillColor: [240, 240, 240], textColor: 0 },
          margin: { left: 14, right: 14 }
        });

        y = doc.lastAutoTable.finalY + 10;

        // Adicionar total geral
        const totalGeral = recalcularTotais();
        doc.setFontSize(12);
        doc.setTextColor('#007b00');
        doc.text(`Total Geral: ${formatBRL(totalGeral)}`, 14, y);

        y += 15;

        // Condições
        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.text('Condições:', 14, y);
        doc.text('- Proposta válida por 15 dias;', 14, y + 6);
        doc.text('- Pagamento mediante boleto ou transferência bancária;', 14, y + 12);
        doc.text('- Início dos serviços após aprovação da proposta.', 14, y + 18);

        y += 35;
        doc.text('Agradecemos pela oportunidade e estamos à disposição para esclarecimentos.', 14, y);
        y += 20;
        doc.text('Atenciosamente,', 14, y);
        doc.text('Equipe GLCTech', 14, y + 6);

        y += 30;
        doc.setLineWidth(0.1);
        doc.line(14, y + 10, 90, y + 10);
        doc.line(120, y + 10, 195, y + 10);
        doc.text('Assinatura GLCTech', 14, y + 15);
        doc.text('Assinatura do Cliente', 120, y + 15);

        doc.save('proposta_comercial_glctech.pdf');

      } catch (error) {
        alert('Erro ao gerar proposta: ' + error);
      }
    });
  </script>
</body>
</html>